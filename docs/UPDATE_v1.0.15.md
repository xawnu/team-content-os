# v1.0.15 更新说明

## 📊 新功能：YouTube API 多 Key 轮询优化

### 主要改进

1. **配额监控面板**
   - 实时显示总配额使用情况
   - 各 Key 详细状态（正常/受限/耗尽/错误）
   - 可视化进度条和颜色编码
   - 支持展开/收起详情

2. **智能 Key 分配**
   - 优先使用配额充足的 Key
   - 自动跳过耗尽或错误的 Key
   - 负载均衡，避免单个 Key 过载

3. **配额预警**
   - 80% 使用率：黄色预警
   - 90% 使用率：红色预警
   - 健康 Key 不足：提前告警

4. **自动重置**
   - 每天凌晨自动重置配额
   - 清除错误计数
   - 恢复所有 Key 状态

5. **详细统计**
   - 每个 Key 的使用量和剩余量
   - 最后使用时间
   - 错误次数记录

### 使用场景

**场景 1：配额监控**
```
打开 Planner 页面 → 顶部显示配额监控面板
→ 查看总配额使用情况
→ 展开查看各 Key 详情
```

**场景 2：智能分配**
```
添加视频到参考池 → 系统自动选择最佳 Key
→ 优先使用配额充足的 Key
→ 避免配额耗尽的 Key
```

**场景 3：配额预警**
```
配额使用达到 80% → 黄色预警提示
→ 提醒用户注意配额使用
→ 建议添加更多 Key 或减少使用
```

### 配置方法

**单个 Key：**
```bash
YOUTUBE_API_KEY=your_key
```

**多个 Key（推荐）：**
```bash
YOUTUBE_API_KEYS=key1,key2,key3
```

### 监控面板说明

**总体配额：**
- 绿色进度条：使用率 < 80%
- 黄色进度条：使用率 80-90%
- 红色进度条：使用率 > 90%

**Key 状态：**
- 🟢 正常：配额充足，可正常使用
- 🟡 受限：配额不足 20%，优先级降低
- 🔴 耗尽：配额用完，暂时不可用
- ⚫ 错误：连续失败 3 次，暂时禁用

### 技术实现

**智能分配算法：**
1. 过滤出可用的 Key（正常/受限状态）
2. 按配额剩余量排序（多的优先）
3. 相同配额时，按最后使用时间排序（早的优先）
4. 返回最佳 Key

**配额追踪：**
- 每次 API 调用后更新使用量
- 成功：配额 +1，错误计数清零
- 失败：错误计数 +1，连续 3 次失败则标记为错误状态

**数据持久化：**
- 使用 localStorage 保存统计信息
- 页面刷新后数据不丢失
- 每天凌晨自动重置

### 注意事项

1. **配额限制**
   - YouTube API 每个 Key 每天 10,000 配额
   - 不同操作消耗不同配额（1-100）
   - 建议配置 3-5 个 Key

2. **重置时间**
   - 配额每天凌晨（太平洋时间）重置
   - 系统会自动检测并重置本地统计

3. **监控数据**
   - 仅在客户端（浏览器）记录
   - 不同浏览器/设备数据独立
   - 不影响服务端逻辑

---

**部署说明：**

1. 拉取最新代码：`git pull origin master`
2. 重新构建：`npm run build`
3. 重启服务：`pm2 restart youtube.9180.net`

**兼容性：**
- 向后兼容，无破坏性变更
- 单 Key 配置仍然可用
- 自动启用智能分配
