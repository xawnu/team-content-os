# v1.0.14 更新说明

## 🛡️ 新功能：AI 调用稳定性增强

### 主要改进

1. **智能重试机制**
   - 失败后自动重试，最多3次
   - 指数退避策略（1s → 2s → 4s）
   - 避免瞬时故障导致的失败

2. **超时控制**
   - 单次调用超时时间：60秒
   - 超时后自动重试或降级
   - 防止长时间等待

3. **本地模板降级**
   - AI 完全不可用时自动切换到本地模板
   - 保证系统始终可用
   - 模板质量经过优化，可满足基本需求

4. **详细日志**
   - 记录每次重试的详细信息
   - 便于问题排查和优化
   - 用户可以看到重试次数

### 问题背景

**之前的问题：**
- AI 服务偶尔不稳定，导致生成失败
- 网络波动可能导致超时
- 失败后需要用户手动重试
- 用户体验差，浪费时间

**现在的解决方案：**
- 自动重试，用户无感知
- 超时后自动处理
- 降级策略保证可用性
- 提升用户体验

### 技术实现

#### 1. 重试机制

**指数退避算法：**
```typescript
function exponentialBackoff(attempt: number, baseDelay: number = 1000): number {
  return Math.min(baseDelay * Math.pow(2, attempt), 10000);
}

// 第1次重试：等待 1秒
// 第2次重试：等待 2秒
// 第3次重试：等待 4秒
// 最大等待：10秒
```

**重试流程：**
```
第1次尝试 → 失败 → 等待1秒 → 第2次尝试
第2次尝试 → 失败 → 等待2秒 → 第3次尝试
第3次尝试 → 失败 → 等待4秒 → 第4次尝试
第4次尝试 → 失败 → 使用本地模板降级
```

#### 2. 超时控制

**实现方式：**
```typescript
const timeoutPromise = new Promise((_, reject) => {
  setTimeout(() => reject(new Error('AI 调用超时')), 60000);
});

const result = await Promise.race([
  apiCall(),
  timeoutPromise,
]);
```

**超时后的处理：**
- 记录超时日志
- 触发重试机制
- 如果多次超时，使用本地模板

#### 3. 本地模板降级

**模板内容：**
- 基础文案结构
- 8段分镜脚本
- 标准化的口播和画面描述
- 符合质量校验标准

**模板示例：**
```json
{
  "topic": "How to Build a Chicken Coop",
  "title": "How to Build a Chicken Coop - 完整指南",
  "opening15s": [
    "大家好，今天我们来聊聊 How to Build a Chicken Coop。",
    "很多人在 How to Build a Chicken Coop 上遇到困难...",
    "接下来我会分享5个实用技巧..."
  ],
  "timeline": [
    {
      "time": "00:00-00:45",
      "segment": "第1段：要点1",
      "voiceover": "现在我们来看第1个要点...",
      "visuals": "画面使用中景镜头展示操作过程..."
    }
  ],
  "provider": "template"
}
```

### 使用场景

**场景 1：网络波动**
```
用户点击生成 → AI 调用超时
→ 自动重试（1秒后）→ 成功
→ 用户无感知，正常获得结果
```

**场景 2：AI 服务临时故障**
```
用户点击生成 → AI 返回错误
→ 自动重试（1秒后）→ 仍然失败
→ 自动重试（2秒后）→ 仍然失败
→ 自动重试（4秒后）→ 成功
→ 用户等待约7秒，获得结果
```

**场景 3：AI 服务完全不可用**
```
用户点击生成 → AI 返回错误
→ 重试3次均失败
→ 自动切换到本地模板
→ 用户获得基础版文案（标注为 template）
→ 可以继续使用，不会完全失败
```

### 用户体验变化

**之前：**
```
生成中... → 失败！
错误：AI 服务不可用
[用户需要手动重试]
```

**现在：**
```
生成中... → 重试中(1/3)... → 重试中(2/3)... → 成功！
或
生成中... → 重试中(1/3)... → 重试中(2/3)... → 重试中(3/3)... → 使用本地模板生成
```

### 日志示例

**成功重试：**
```
AI 调用失败 (尝试 1/4): 网络超时
等待 1000ms 后重试...
AI 调用失败 (尝试 2/4): 网络超时
等待 2000ms 后重试...
AI 调用成功 (重试 2 次)
```

**降级到模板：**
```
AI 调用失败 (尝试 1/4): 服务不可用
等待 1000ms 后重试...
AI 调用失败 (尝试 2/4): 服务不可用
等待 2000ms 后重试...
AI 调用失败 (尝试 3/4): 服务不可用
等待 4000ms 后重试...
AI 调用失败 (尝试 4/4): 服务不可用
AI 调用失败，使用本地模板降级
```

### 性能影响

**正常情况（AI 服务正常）：**
- 无额外延迟
- 第一次调用即成功

**网络波动（需要1次重试）：**
- 额外延迟：约1秒
- 用户可接受

**AI 服务故障（需要3次重试）：**
- 额外延迟：约7秒（1+2+4）
- 但最终能成功或降级

**完全降级（使用本地模板）：**
- 额外延迟：约7秒（重试时间）
- 但保证了可用性

### 质量保证

**本地模板质量：**
- 符合所有质量校验标准
- 8段分镜脚本
- 每段口播≥60字
- 每段画面描述≥40字
- 包含具体镜头动作

**模板 vs AI 对比：**
| 维度 | AI 生成 | 本地模板 |
|------|---------|----------|
| 创意性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 个性化 | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 稳定性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 速度 | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 可用性 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

### 配置选项

**可调整参数：**
```typescript
{
  maxRetries: 3,        // 最大重试次数
  retryDelay: 1000,     // 基础延迟（毫秒）
  timeout: 60000,       // 超时时间（毫秒）
}
```

**建议配置：**
- 生产环境：maxRetries=3, timeout=60000
- 测试环境：maxRetries=1, timeout=30000
- 快速模式：maxRetries=0, timeout=10000（不推荐）

### 监控和告警

**建议监控指标：**
- AI 调用成功率
- 平均重试次数
- 降级使用频率
- 平均响应时间

**告警阈值：**
- 成功率 < 90%：警告
- 成功率 < 80%：严重
- 降级率 > 10%：警告
- 降级率 > 20%：严重

### 注意事项

1. **本地模板的局限性**
   - 创意性较低
   - 个性化不足
   - 适合应急使用

2. **重试会增加延迟**
   - 正常情况无影响
   - 故障时会有7秒左右延迟
   - 但保证了可用性

3. **日志记录**
   - 重试和降级会记录日志
   - 便于问题排查
   - 不影响用户体验

### 下一步优化

- [ ] 支持多个 AI 模型切换（GPT-4 → Claude → Gemini）
- [ ] 增加更多本地模板（按类型分类）
- [ ] 支持自定义重试策略
- [ ] 增加实时监控面板

---

**部署说明：**

1. 拉取最新代码：`git pull origin master`
2. 重新构建：`npm run build`
3. 重启服务：`pm2 restart youtube.9180.net`

**兼容性：**
- 向后兼容，无破坏性变更
- 现有功能不受影响
- 自动启用稳定性增强
